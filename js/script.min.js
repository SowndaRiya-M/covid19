let gData,gRegions=[],gThresholds={carriers:0,discharged:0,deaths:0,pcrtested:0};const LANG=$("html").attr("lang"),SCROLLBAR_WIDTH=window.innerWidth-$(window).width(),COLORS={default:"#3DC",second:"#FEA",deaths:"#FB8",serious:"#FEA",pcrtests:"#6F6587,#5987A5,#3BA9B0,#48C7A6,#86E18D,#D5F474".split(","),dark:"#399",selected:"#EC2"},LABELS={ja:{change:"前日比",total:"合計",transition:{carriers:["PCR検査陽性者数"],cases:["入院治療等を要する者"],discharged:["退院・療養解除"],serious:["重症者数"],deaths:["死亡者数"],pcrtested:["PCR検査人数"],pcrtests:["国立感染症研究所","検疫所","地方衛生研究所・保健所","民間検査会社","大学等","医療機関"],reproduction:["実効再生産数"]},unit:{carriers:"名",cases:"名",discharged:"名",serious:"名",deaths:"名",pcrtested:"名",pcrtests:"件",reproduction:""},demography:{deaths:"死亡者",serious:"重症者",hospitalized:"要治療",discharged:"回復済"},age:["80代以上","70代","60代","50代","40代","30代","20代","10代","10歳未満","不明"]},en:{change:"Daily: ",total:"Total",transition:{carriers:["Tested Positive"],cases:["Active Cases"],discharged:["Discharged"],serious:["Serious"],deaths:["Deaths"],pcrtested:["PCR Tested"],pcrtests:["National Institute of Infectious Diseases","Quarantine Stations","Public Health Institute, Public Health Center","Private Testing Companies","Universities","Medical Institutions"],reproduction:["Effective Reproduction Number"]},unit:{carriers:"",cases:"",discharged:"",serious:"",deaths:"",pcrtested:"",pcrtests:"",reproduction:""},demography:{deaths:"Deaths",serious:"Serious",hospitalized:"Hospitalized",discharged:"Discharged"},age:["80s+","70s","60s","50s","40s","30s","20s","10s","Under 10","Unknown"]}},init=()=>{const t=t=>String(t).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),e=(e,a,s,r=!1)=>{const o=(t,e,a,s,r)=>{let o=COLORS.default,i=n(a,s,!0);return""===e&&("carriers"===t&&i<20200508&&(o=COLORS.second),"cases"===t&&i<20200508&&(o=COLORS.second),"deaths"===t&&i<20200422&&(o=COLORS.second),"discharged"===t&&(i<20200508&&(o=COLORS.second),i<20200422&&(o=COLORS.default)),"pcrtested"===t&&i<20200929&&(o=COLORS.second)),"13"===e&&("pcrtested"===t&&i<20200507&&(o=COLORS.second),"serious"===t&&i<20200427&&(o=COLORS.second)),"14"===e&&"pcrtested"===t&&i<20200701&&(o=COLORS.second),"22"===e&&"pcrtested"===t&&i<20200622&&(o=COLORS.second),"28"===e&&"pcrtested"===t&&i<20200619&&(o=COLORS.second),"40"===e&&"pcrtested"===t&&i<20200929&&(o=COLORS.second),""!==e&&"13"!==e&&"serious"===t&&i<20200508&&(o=COLORS.second),""===e&&"pcrtests"===t&&(o=COLORS.pcrtests[r]),"reproduction"===t&&(o="#242A3C"),o},n=(t,e,a)=>{let s=new Date(t[0],t[1]-1,t[2]);s.setDate(s.getDate()+e);let r="",o=s.getFullYear(),n=s.getMonth()+1,i=s.getDate();if(a){r=1e4*parseInt(o)+100*parseInt(n)+parseInt(i)}else"ja"===LANG&&(r=n+"/"+i),"en"===LANG&&(r=n+"/"+i);return r};let i=e.find(".main-chart").empty().html("<canvas></canvas>"),d=i.find("canvas")[0],l=e.find(".switch.selected").attr("value"),c=!!e.find(".checkbox.moving-average").hasClass("on"),h=gData.transition[a];""!==s&&(h=gData["prefectures-data"][parseInt(s)-1][a]);let p=h.from,u=h.values;((e,a)=>{let s=0,r=0;for(let t=0;t<a.length;t++)for(let e=0;e<a[0].length;e++)s+=a[t][e],t===a.length-1&&(r+=a[t][e]);"reproduction"===e.attr("code")&&(s=Math.round(100*a[a.length-1][0])/100,r=Math.round(100*(a[a.length-1][0]-a[a.length-2][0]))/100),s=t(s),"-"!==(r=t(r)).charAt(0)&&(r="+"+r);let o=e.find(".latest");o.find(".value").text(s),o.find(".unit").text(LABELS[LANG].unit[e.attr("code")]),o.find(".type").text((t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase())(e.find(".switch[value=total]").text())),o.find(".change").text(LABELS[LANG].change+" "+r)})(e,u);let g={type:"bar",data:{labels:[],datasets:[]},options:{maintainAspectRatio:!1,animation:{duration:r?1e3:0},legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!1,callbacks:{title:function(t){let a=t[0].xLabel.trim();"ja"===LANG&&(a=a.replace("/","月")+"日時点"),"en"===LANG&&(a="As of "+a);return a+" "+e.find(".switch.selected").text()},label:function(e,s){let r=[],o=0;s.datasets.forEach(function(s,n){(!c||n>=1)&&(r.push(s.label+": "+t(s.data[e.index])+" "+LABELS[LANG].unit[a]),o+=s.data[e.index])});let n=c?3:2;return s.datasets.length>=n&&r.push(LABELS[LANG].total+": "+t(o)+" "+LABELS[LANG].unit[a]),r}}},scales:{xAxes:[{stacked:!0,gridLines:{display:!1,zeroLineColor:"rgba(255,255,0,0.7)"},ticks:{fontColor:"rgba(255,255,255,0.7)",maxRotation:0,minRotation:0,callback:t=>" "+t+" "}}],yAxes:[{location:"bottom",stacked:!0,gridLines:{display:!0,zeroLineColor:"rgba(255,255,255,0.7)",borderDash:[3,1],color:"rgba(255, 255, 255, 0.3)"},ticks:{beginAtZero:!0,fontColor:"transparent"}}]},layout:{padding:{left:10}}}};for(let t=0;t<u[0].length;t++)if(g.data.datasets.push({label:LABELS[LANG].transition[a][t],backgroundColor:[],data:[]}),"reproduction"===a){let t=g.data.datasets[g.data.datasets.length-1];t.type="line",t.fill=!1,t.pointRadius=2,t.pointBorderColor="#EC2",t.borderColor="#EC2"}let f="",b=[];for(let t=0;t<u[0].length;t++)b.push(0);if(u.forEach(function(t,e){let r=o(a,s,p,e,0);g.data.labels.push(n(p,e,!1));for(let n=0;n<u[0].length;n++){b[n]+=t[n];let i=t[n];f!==r&&"reproduction"!==a&&(i=0),""===t[n]&&(i=0),i<0&&("total"===l||"carriers"===a||"discharged"===a||"deaths"===a||"pcrtested"===a||"pcrtests"===a)&&(i=0),"total"===l&&(i=b[n]),g.data.datasets[n].data.push(i),g.data.datasets[n].backgroundColor.push(o(a,s,p,e,n))}f=r}),i.width(Math.max(8*g.data.labels.length,i.width())),c){let t={type:"line",label:LABELS[LANG].movingAverage,fill:!1,borderColor:"#FBA",borderWidth:3,pointRadius:0,data:[]};for(let e=0;e<g.data.datasets[0].data.length;e++){let a=null;if(e>=7){a=0;for(let t=0;t<7;t++)g.data.datasets.forEach(function(s,r){a+=parseInt(s.data[e-t])});a/=7}t.data.push(a)}g.data.datasets.unshift(t)}((t,e)=>{let a=t.find("h5.updated");if(!a.hasClass("show")){let t=e.data.labels[e.data.labels.length-1],s={ja:t.replace("/","月")+"日時点",en:"As of "+(e=>{let a=t.split("/");return a[1]+" "+["January","February","March","April","May","June","July","August","September","October","November","December"][parseInt(a[0])-1]})()};a.text(s[LANG]),a.addClass("show")}})(e,g),((e,a,s)=>{let r=e.find(".axis-chart").empty().html("<canvas></canvas>").find("canvas")[0],o={type:"bar",data:a,options:{maintainAspectRatio:!1,legend:{display:!1},title:{display:!1},scales:{xAxes:[{stacked:s,drawBorder:!1,gridLines:{display:!1},ticks:{fontColor:"rgba(255,255,255,0.0)",maxRotation:0,minRotation:0}}],yAxes:[{id:"axisScale",location:"bottom",stacked:s,gridLines:{drawBorder:!1,display:!1},ticks:{beginAtZero:!0,fontColor:"rgba(255,255,255,0.7)",callback:function(e,a,s){if(Math.floor(e)===e)return t(e.toString())}}}]}}};o.data.datasets.forEach(function(t,e){t.backgroundColor="transparent",t.borderColor="transparent",t.pointBorderColor="transparent"}),o.data.labels.forEach(function(t,e){}),window.myChart=new Chart(r.getContext("2d"),o);let n=window.myChart.scales.axisScale.max,i=window.myChart.scales.axisScale.min,d=0;switch(Math.max(n.toString().length,i.toString().length)){case 1:d=36;break;case 2:d=40;break;case 3:d=48;break;case 4:d=54;break;case 5:d=66;break;case 6:d=72;break;case 7:d=78}e.find(".axis-cover").width(d.toString()+"px")})(e,$.extend(!0,{},g.data),!0),window.myChart=new Chart(d.getContext("2d"),g)},a=t=>{let e=t.find(".main-chart");t.find(".main-chart-wrapper").animate({scrollLeft:e.width()},0)},s=t=>{let e=0;return t.forEach(function(t,a){t.forEach(function(t,a){e+=t})}),e},r=t=>{let e=$("#select-pref-type").val(),a="rgba(90, 90, 90, 0.6)",r=s(gData["prefectures-data"][parseInt(t)-1][e].values);return r>=1&&(a=COLORS.dark,0===gThresholds[e]&&(a=COLORS.default)),r>=gThresholds[e]&&gThresholds[e]>=1&&(a=COLORS.default),a},o=()=>{$("#japan-map").empty();const t=$("#japan-map").width();let e=[];gData["prefectures-map"].forEach(function(t,a){e.push({code:t.code,jp:t.ja,en:t.en,color:r(t.code),hoverColor:COLORS.selected,prefectures:[t.code]})}),$("#japan-map").japanMap({areas:e,selection:"prefecture",width:t,borderLineColor:"#242a3c",borderLineWidth:.25,lineColor:"#ccc",lineWidth:1,drawsBoxLine:!1,showsPrefectureName:!1,movesIslands:!0,onHover:function(t){n(t.code),i(t.code)}})},n=e=>{let a=$("#region-chart").empty().html("<canvas></canvas>"),o=a.find("canvas")[0],n=$("#select-pref-type").val(),d={type:"horizontalBar",data:{labels:[],datasets:[{label:"",backgroundColor:[],data:[]}]},options:{aspectRatio:.4,animation:{duration:1e3},responsive:!0,legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(t){return gData["prefectures-map"].forEach(function(e,a){e.ja!==t[0].yLabel&&e.en!==t[0].yLabel||$("#select-prefecture").val()!==e.code&&i(e.code)}),t[0].yLabel},label:function(t,e){return t.xLabel+{ja:" 名",en:" cases"}[LANG]}}},scales:{xAxes:[{position:"top",gridLines:{color:"rgba(255,255,255,0.2)"},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(e,a,s){return t(e)}}}],yAxes:[{gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};a.outerWidth()>=400&&(d.options.aspectRatio=.5),""!==e&&(d.options.animation.duration=0);let l=[];gData["prefectures-data"].forEach(function(t,e){l.push({name:gData["prefectures-map"][e][LANG],value:s(t[n].values),code:(e+1).toString()})}),l.sort((t,e)=>t.value<e.value?1:t.value>e.value?-1:0),l.forEach(function(t,a){d.data.labels.push(t.name),d.data.datasets[0].data.push(t.value),e==t.code?d.data.datasets[0].backgroundColor.push(COLORS.selected):d.data.datasets[0].backgroundColor.push(r(t.code))});let c=o.getContext("2d");window.myChart=new Chart(c,d)},i=t=>{$("#select-prefecture").val(t),$(".transition.prefecture").each(function(){$(this).attr("pref",t),$(this).find("h3").find("span").text(gData["prefectures-map"][parseInt(t)-1][LANG]),e($(this),$(this).attr("code"),$(this).attr("pref"),!0),a($(this))})};$.getJSON("data/data.json",function(r){gData=r,(()=>{const t=t=>{let e=t.sort((t,e)=>t-e),a=[Math.floor(t.length/2),Math.ceil(t.length/2)];return(e[a[0]]+e[a[1]])/2};for(thType in gThresholds){let e=[];gData["prefectures-data"].forEach(function(t,a){e.push(s(t[thType].values))}),gThresholds[thType]=t(e)}})(),$(".transition.nationwide").each(function(){e($(this),$(this).attr("code"),$(this).attr("pref"),!0),a($(this))}),(()=>{$wrapper=$("#demography-chart").empty().html("<canvas></canvas>"),$canvas=$wrapper.find("canvas")[0];let e={type:"horizontalBar",data:{labels:[],datasets:[{label:LABELS[LANG].demography.deaths,backgroundColor:COLORS.deaths,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.serious,backgroundColor:COLORS.serious,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.hospitalized,backgroundColor:COLORS.default,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.discharged,backgroundColor:COLORS.dark,borderWidth:.5,borderColor:"#242a3c",data:[]}]},options:{aspectRatio:.9,responsive:!0,legend:{display:!0,labels:{fontColor:"rgba(255, 255, 255, 0.7)"}},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(e){let a=e[0].yLabel,s=0;return e.forEach(function(t,e){s+=t.xLabel}),a+": "+t(s)+" "+{ja:"名",en:"cases"}[LANG]},label:function(e,a){return a.datasets[e.datasetIndex].label+": "+t(e.value)+{ja:"名",en:" cases"}[LANG]}}},scales:{xAxes:[{stacked:!0,position:"top",gridLines:{color:"rgba(255,255,255,0.2)",zeroLineColor:"rgba(255,255,255,0.2)",borderDash:[3,1]},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(e,a,s){return t(e)}}}],yAxes:[{stacked:!0,barPercentage:.7,gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};$wrapper.outerWidth()>=400&&(e.options.aspectRatio=1.1),$wrapper.outerWidth()>=600&&(e.options.aspectRatio=1.3),gData.demography.forEach(function(t,a){e.data.labels.push(LABELS[LANG].age[a]);for(let a=0;a<Object.keys(LABELS[LANG].demography).length;a++)e.data.datasets[a].data.push(t[a])});let a=$canvas.getContext("2d");window.myChart=new Chart(a,e)})(),o(),n(""),i("13"),$(".updated-last").text(gData.updated.last[LANG]),$(".updated-demography").text(gData.updated.demography[LANG]),$(".transition").each(function(){$(this).find(".axis-chart").css("height","calc(100% - "+SCROLLBAR_WIDTH+"px)"),$(this).find(".axis-cover").css("height","calc(100% - "+SCROLLBAR_WIDTH+"px)")}),$("#cover-block").fadeOut()}),$(".transition").find(".switch").on("click",function(){let t=$(this).closest(".transition");$(this).siblings(".switch").removeClass("selected"),$(this).addClass("selected"),e(t,t.attr("code"),t.attr("pref"),!0)}),$("#select-prefecture").on("change",function(){let t=$(this).val();i(t)}),$("#select-pref-type").on("change",function(){o(),n("")}),$(".more").on("click",function(){$(this).closest("p.notes").addClass("show")}),$(".checkboxes").find(".checkbox").on("click",function(){$(this).hasClass("on")?$(this).removeClass("on"):$(this).addClass("on");let t=$(this).closest(".transition");e(t,t.attr("code"),t.attr("pref"),!1)}),$('a[href^="#"]').click(function(){let t=$(this).attr("href"),e=$(t).offset().top;return $("body,html").animate({scrollTop:e},400,"swing"),!1})};$(function(){init()});